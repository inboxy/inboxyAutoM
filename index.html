<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Recording PWA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="material3-tabs.css">
    <meta name="theme-color" content="#6750A4">
    <meta name="description" content="High-frequency sensor data recording application">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNjc1MEE0Ii8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjgiIGZpbGw9IiNGRkZCRkUiLz4KPC9zdmc+Cg==">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Preload critical JavaScript files -->
    <link rel="preload" href="app.js" as="script">
    <link rel="preload" href="network.js" as="script">
</head>
<body>
    <!-- App Header -->
    <header class="app-header">
        <h1 class="app-title">Motion Recorder</h1>
        <div class="app-status">
            <div class="status-item">
                <span class="material-icons">wifi</span>
                <span id="online-status" class="info-value online-status online">Online</span>
            </div>
            <div class="status-item" id="recording-indicator" style="display: none;">
                <span class="material-icons recording-pulse">radio_button_checked</span>
                <span>Recording</span>
            </div>
        </div>
    </header>

    <!-- Material 3 Tab Navigation -->
    <div class="tab-container">
        <div class="tab-bar" role="tablist">
            <button class="tab-button active" role="tab" aria-selected="true" aria-controls="permissions-panel" data-tab="permissions">
                <span class="material-icons">security</span>
                <span class="tab-label">Permissions</span>
                <div class="tab-indicator"></div>
            </button>
            <button class="tab-button" role="tab" aria-selected="false" aria-controls="performance-panel" data-tab="performance">
                <span class="material-icons">speed</span>
                <span class="tab-label">Performance</span>
                <div class="tab-indicator"></div>
            </button>
            <button class="tab-button" role="tab" aria-selected="false" aria-controls="sensors-panel" data-tab="sensors">
                <span class="material-icons">sensors</span>
                <span class="tab-label">Live Data</span>
                <div class="tab-indicator"></div>
            </button>
            <button class="tab-button" role="tab" aria-selected="false" aria-controls="data-panel" data-tab="data">
                <span class="material-icons">storage</span>
                <span class="tab-label">Data</span>
                <div class="tab-indicator"></div>
            </button>
        </div>

        <!-- Tab Panels -->
        <div class="tab-content">
            <!-- Permissions Tab -->
            <div id="permissions-panel" class="tab-panel active" role="tabpanel">
                <div class="panel-header">
                    <h2>Sensor Permissions</h2>
                    <p class="panel-subtitle">Grant permissions to access device sensors</p>
                </div>
                
                <div class="permissions-grid">
                    <div class="permission-card">
                        <div class="permission-icon-container">
                            <span class="material-icons">location_on</span>
                        </div>
                        <div class="permission-info">
                            <h3>GPS Location</h3>
                            <p>Access device location for positioning data</p>
                        </div>
                        <div class="permission-status-container">
                            <span id="gps-status" class="permission-status status-pending">Pending</span>
                            <button id="gps-retry" class="icon-button" style="display: none;" aria-label="Retry GPS permission">
                                <span class="material-icons">refresh</span>
                            </button>
                        </div>
                    </div>

                    <div class="permission-card">
                        <div class="permission-icon-container">
                            <span class="material-icons">hourglass_empty</span>
                        </div>
                        <div class="permission-info">
                            <h3>Accelerometer</h3>
                            <p>Detect device motion and acceleration</p>
                        </div>
                        <div class="permission-status-container">
                            <span id="accel-status" class="permission-status status-pending">Pending</span>
                            <button id="accel-retry" class="icon-button" style="display: none;" aria-label="Retry accelerometer permission">
                                <span class="material-icons">refresh</span>
                            </button>
                        </div>
                    </div>

                    <div class="permission-card">
                        <div class="permission-icon-container">
                            <span class="material-icons">rotate_right</span>
                        </div>
                        <div class="permission-info">
                            <h3>Gyroscope</h3>
                            <p>Measure device rotation and orientation</p>
                        </div>
                        <div class="permission-status-container">
                            <span id="gyro-status" class="permission-status status-pending">Pending</span>
                            <button id="gyro-retry" class="icon-button" style="display: none;" aria-label="Retry gyroscope permission">
                                <span class="material-icons">refresh</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="permissions-actions">
                    <button id="request-permissions-btn" class="button button-primary" style="display: none;">
                        <span class="material-icons">security</span>
                        Request Sensor Permissions
                    </button>
                    <div id="permission-help" class="help-text" style="display: none;">
                        On iOS devices, you need to explicitly grant motion sensor permissions.
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div id="performance-panel" class="tab-panel" role="tabpanel">
                <div class="panel-header">
                    <h2>Performance Monitor</h2>
                    <p class="panel-subtitle">Real-time performance metrics and system stats</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-card primary">
                        <div class="metric-icon">
                            <span class="material-icons">speed</span>
                        </div>
                        <div class="metric-content">
                            <h3>Sample Rate</h3>
                            <div class="metric-value">
                                <span id="sample-rate" class="value">-- Hz</span>
                                <div class="rate-indicator">
                                    <div id="rate-bar" class="rate-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">
                            <span class="material-icons">data_usage</span>
                        </div>
                        <div class="metric-content">
                            <h3>Data Points</h3>
                            <span id="data-count" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">
                            <span class="material-icons">memory</span>
                        </div>
                        <div class="metric-content">
                            <h3>Buffer Size</h3>
                            <span id="buffer-size" class="metric-value">0</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">
                            <span class="material-icons">timer</span>
                        </div>
                        <div class="metric-content">
                            <h3>Recording Time</h3>
                            <span id="recording-time" class="metric-value">00:00</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">
                            <span class="material-icons">storage</span>
                        </div>
                        <div class="metric-content">
                            <h3>Memory Usage</h3>
                            <span id="memory-usage" class="metric-value">-- MB</span>
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-icon">
                            <span class="material-icons">battery_std</span>
                        </div>
                        <div class="metric-content">
                            <h3>Battery Level</h3>
                            <span id="battery-level" class="metric-value">100%</span>
                        </div>
                    </div>
                </div>

                <div class="performance-chart">
                    <h3>Real-time Sample Rate</h3>
                    <div id="performance-monitor" class="chart-container">
                        <div class="chart-placeholder">Performance chart will display during recording</div>
                    </div>
                </div>
            </div>

            <!-- Live Sensor Data Tab -->
            <div id="sensors-panel" class="tab-panel" role="tabpanel">
                <div class="panel-header">
                    <h2>Live Sensor Data</h2>
                    <p class="panel-subtitle">Real-time sensor readings optimized for mobile viewing</p>
                </div>

                <div class="sensor-data-stack">
                    <div class="sensor-card">
                        <div class="sensor-header">
                            <span class="material-icons">location_on</span>
                            <h3>GPS Location</h3>
                        </div>
                        <div class="sensor-readings-grid">
                            <div class="reading-item">
                                <span class="reading-label">Latitude</span>
                                <span id="gps-lat" class="reading-value">--</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Longitude</span>
                                <span id="gps-lon" class="reading-value">--</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Altitude</span>
                                <span id="gps-altitude" class="reading-value">-- m</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Accuracy</span>
                                <span id="gps-accuracy" class="reading-value">-- m</span>
                            </div>
                        </div>
                    </div>

                    <div class="sensor-card">
                        <div class="sensor-header">
                            <span class="material-icons">hourglass_empty</span>
                            <h3>Accelerometer</h3>
                            <div class="sensor-unit">m/s²</div>
                        </div>
                        <div class="sensor-readings-grid">
                            <div class="reading-item">
                                <span class="reading-label">X-Axis</span>
                                <span id="accel-x" class="reading-value">0.00</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Y-Axis</span>
                                <span id="accel-y" class="reading-value">0.00</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Z-Axis</span>
                                <span id="accel-z" class="reading-value">0.00</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Magnitude</span>
                                <span id="accel-magnitude" class="reading-value">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="sensor-card">
                        <div class="sensor-header">
                            <span class="material-icons">rotate_right</span>
                            <h3>Gyroscope</h3>
                            <div class="sensor-unit">°/s</div>
                        </div>
                        <div class="sensor-readings-grid">
                            <div class="reading-item">
                                <span class="reading-label">Alpha (Z)</span>
                                <span id="gyro-alpha" class="reading-value">0.00</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Beta (X)</span>
                                <span id="gyro-beta" class="reading-value">0.00</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Gamma (Y)</span>
                                <span id="gyro-gamma" class="reading-value">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="sensor-card">
                        <div class="sensor-header">
                            <span class="material-icons">compass_calibration</span>
                            <h3>Device Orientation</h3>
                            <div class="sensor-unit">degrees</div>
                        </div>
                        <div class="sensor-readings-grid">
                            <div class="reading-item">
                                <span class="reading-label">Compass</span>
                                <span id="orientation-compass" class="reading-value">--°</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Tilt (Beta)</span>
                                <span id="orientation-beta" class="reading-value">--°</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Roll (Gamma)</span>
                                <span id="orientation-gamma" class="reading-value">--°</span>
                            </div>
                        </div>
                    </div>

                    <div class="sensor-card">
                        <div class="sensor-header">
                            <span class="material-icons">update</span>
                            <h3>Sensor Status</h3>
                        </div>
                        <div class="sensor-readings-grid">
                            <div class="reading-item">
                                <span class="reading-label">Sample Rate</span>
                                <span id="live-sample-rate" class="reading-value">-- Hz</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Last Update</span>
                                <span id="last-sensor-update" class="reading-value">--</span>
                            </div>
                            <div class="reading-item">
                                <span class="reading-label">Data Points</span>
                                <span id="live-data-count" class="reading-value">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Management Tab -->
            <div id="data-panel" class="tab-panel" role="tabpanel">
                <div class="panel-header">
                    <h2>Application Data</h2>
                    <p class="panel-subtitle">Manage recordings, exports, and storage</p>
                </div>

                <div class="data-overview">
                    <div class="overview-card">
                        <div class="overview-icon">
                            <span class="material-icons">folder</span>
                        </div>
                        <div class="overview-content">
                            <h3>Total Recordings</h3>
                            <span id="total-recordings" class="overview-value">0</span>
                        </div>
                    </div>

                    <div class="overview-card">
                        <div class="overview-icon">
                            <span class="material-icons">storage</span>
                        </div>
                        <div class="overview-content">
                            <h3>Storage Used</h3>
                            <span id="storage-used" class="overview-value">0 MB</span>
                        </div>
                    </div>

                    <div class="overview-card">
                        <div class="overview-icon">
                            <span class="material-icons">person</span>
                        </div>
                        <div class="overview-content">
                            <h3>User ID</h3>
                            <span id="user-id" class="overview-value">Loading...</span>
                        </div>
                    </div>
                </div>

                <div class="data-actions">
                    <div class="action-section">
                        <h3>Export Data</h3>
                        <div class="action-buttons">
                            <button id="download-btn" class="button button-secondary">
                                <span class="material-icons">download</span>
                                Download CSV
                            </button>
                            <button id="upload-btn" class="button button-secondary">
                                <span class="material-icons">cloud_upload</span>
                                Upload JSON
                            </button>
                            <button id="export-data-btn" class="button button-primary">
                                <span class="material-icons">archive</span>
                                Export All Data
                            </button>
                        </div>
                    </div>

                    <div class="action-section danger">
                        <h3>Data Management</h3>
                        <div class="action-buttons">
                            <button id="clear-data-btn" class="button button-danger">
                                <span class="material-icons">delete_forever</span>
                                Clear All Data
                            </button>
                        </div>
                        <p class="danger-warning">
                            <span class="material-icons">warning</span>
                            This action will permanently delete all recordings and cannot be undone.
                        </p>
                    </div>
                </div>

                <div class="recordings-list" id="recordings-list">
                    <h3>Recent Recordings</h3>
                    <div class="recordings-container">
                        <div class="empty-state">
                            <span class="material-icons">folder_open</span>
                            <p>No recordings yet. Start recording to see your data here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Circular Record Button -->
    <div class="record-button-container" style="position: fixed !important; bottom: 24px !important; right: 24px !important; z-index: 9999 !important; width: 80px; height: 80px;">
        <button id="circular-record-btn" class="circular-record-button" aria-label="Start Recording" style="width: 80px !important; height: 80px !important; border-radius: 50% !important; border: none !important; background: #DC2626 !important; color: white !important; display: flex !important; align-items: center !important; justify-content: center !important; cursor: pointer !important; font-size: 32px !important; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;">
            <span class="material-icons" style="color: white !important; font-size: 32px !important;">radio_button_checked</span>
        </button>
    </div>


    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>
    </div>

    <!-- Additional Loading Element for UI Manager -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p class="loading-text">Processing...</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="https://unpkg.com/nanoid@3.3.7/nanoid.js"></script>
    
    <!-- Network Status Management -->
    <script type="module" src="network.js"></script>
    
    <!-- Tab Management -->
    <script src="material3-tabs.js"></script>
    
    <!-- Main Application Module -->
    <script type="module" src="app.js"></script>

    <!-- Permissions Handler -->
    <script src="permissions.js"></script>

    <!-- Global Error Handlers -->
    <script type="module">
        import { ErrorBoundary } from './utils.js';
        
        // Global error handler for uncaught exceptions
        window.addEventListener('error', (event) => {
            ErrorBoundary.handle(event.error || new Error(event.message), 'Uncaught Exception');
        });
        
        // Global handler for unhandled promise rejections
        window.addEventListener('unhandledrejection', (event) => {
            ErrorBoundary.handle(event.reason, 'Unhandled Promise Rejection');
            // Prevent the default browser behavior (console error)
            event.preventDefault();
        });
        
        // Monitor for resource loading errors (images, scripts, etc.)
        window.addEventListener('error', (event) => {
            if (event.target !== window) {
                const resource = event.target;
                ErrorBoundary.handle(
                    new Error(`Failed to load resource: ${resource.src || resource.href || 'unknown'}`),
                    'Resource Loading'
                );
            }
        }, true); // Use capture phase to catch resource errors
        
        // Performance monitoring for error patterns
        let performanceErrorCount = 0;
        const originalConsoleError = console.error;
        console.error = (...args) => {
            performanceErrorCount++;
            
            // Log excessive console errors
            if (performanceErrorCount > 20) {
                ErrorBoundary.handle(
                    new Error('Excessive console errors detected'),
                    'Performance Warning'
                );
                performanceErrorCount = 0; // Reset counter
            }
            
            // Call original console.error
            originalConsoleError.apply(console, args);
        };
        
        console.log('✅ Global error handlers initialized');
    </script>

    <!-- Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('✅ Service Worker registered successfully:', registration);
                    
                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        console.log('🔄 Service Worker update found');
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'activated') {
                                console.log('✅ Service Worker updated and activated');
                                // Optionally show notification to user about update
                                if (window.app && window.app.showNotification) {
                                    window.app.showNotification('App updated! Refresh for latest features.', 'info', 8000);
                                }
                            }
                        });
                    });
                })
                .catch(error => {
                    console.warn('❌ Service Worker registration failed:', error);
                    // Use ErrorBoundary if available
                    if (window.ErrorBoundary) {
                        window.ErrorBoundary.handle(error, 'Service Worker Registration');
                    }
                });
        } else {
            console.warn('⚠️ Service Workers not supported in this browser');
        }
    </script>
</body>
</html>