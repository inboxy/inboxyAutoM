<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Recording PWA</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <meta name="theme-color" content="#6750A4">
    <meta name="description" content="High-frequency sensor data recording application">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiBmaWxsPSIjNjc1MEE0Ii8+CjxjaXJjbGUgY3g9IjE2IiBjeT0iMTYiIHI9IjgiIGZpbGw9IiNGRkZCRkUiLz4KPC9zdmc+Cg==">
</head>
<body>
    <div class="container">
        <div class="card">
            <h2 class="card-title">Sensor Permissions</h2>
            <div class="permissions-grid">
                <div class="permission-item">
                    <svg class="permission-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                    <span>GPS</span>
                    <span id="gps-status" class="permission-status status-pending" aria-live="polite">Pending</span>
                    <button id="gps-retry" class="retry-permission" style="display: none;" aria-label="Retry GPS permission">
                        Retry
                    </button>
                </div>
                <div class="permission-item">
                    <svg class="permission-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
                    </svg>
                    <span>Accelerometer</span>
                    <span id="accel-status" class="permission-status status-pending" aria-live="polite">Pending</span>
                    <button id="accel-retry" class="retry-permission" style="display: none;" aria-label="Retry accelerometer permission">
                        Retry
                    </button>
                </div>
                <div class="permission-item">
                    <svg class="permission-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm1-13h-2v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                    <span>Gyroscope</span>
                    <span id="gyro-status" class="permission-status status-pending" aria-live="polite">Pending</span>
                    <button id="gyro-retry" class="retry-permission" style="display: none;" aria-label="Retry gyroscope permission">
                        Retry
                    </button>
                </div>

<!-- Add this after the permissions-grid div in your index.html -->
<div class="permissions-actions" style="margin-top: 16px; text-align: center;">
    <button id="request-permissions-btn" class="button button-primary" style="display: none;">
        üîê Request Sensor Permissions
    </button>
    <div id="permission-help" class="help-text" style="margin-top: 8px; display: none;">
        On iOS devices, you need to explicitly grant motion sensor permissions.
    </div>
</div>

<script>
// Add permission request functionality
document.addEventListener('DOMContentLoaded', () => {
    const requestBtn = document.getElementById('request-permissions-btn');
    const helpText = document.getElementById('permission-help');
    
    // Show the button on iOS devices or if permissions are needed
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const needsPermissionRequest = typeof DeviceMotionEvent !== 'undefined' && 
                                   typeof DeviceMotionEvent.requestPermission === 'function';
    
    if (isIOS || needsPermissionRequest) {
        requestBtn.style.display = 'inline-flex';
        helpText.style.display = 'block';
        
        requestBtn.addEventListener('click', async () => {
            try {
                requestBtn.textContent = 'Requesting Permissions...';
                requestBtn.disabled = true;
                
                // Request motion permissions
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const permission = await DeviceMotionEvent.requestPermission();
                    console.log('Motion permission:', permission);
                    
                    if (permission === 'granted') {
                        requestBtn.textContent = '‚úÖ Permissions Granted';
                        requestBtn.style.background = 'var(--md-sys-color-success)';
                        
                        // Trigger permission recheck in the app
                        if (window.app && window.app.sensorManager) {
                            setTimeout(() => {
                                window.app.sensorManager.checkPermissions();
                            }, 500);
                        }
                    } else {
                        requestBtn.textContent = '‚ùå Permission Denied';
                        requestBtn.style.background = 'var(--md-sys-color-error)';
                        requestBtn.disabled = false;
                    }
                }
                
                // Also request geolocation if not already granted
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        () => console.log('GPS permission granted'),
                        () => console.log('GPS permission denied'),
                        { enableHighAccuracy: true, timeout: 5000 }
                    );
                }
                
            } catch (error) {
                console.error('Permission request failed:', error);
                requestBtn.textContent = '‚ùå Request Failed';
                requestBtn.style.background = 'var(--md-sys-color-error)';
                requestBtn.disabled = false;
            }
        });
    }
});
</script>

                
            </div>

            <!-- Performance Monitor Section -->
            <div class="card">
                <h2 class="card-title">Performance Monitor</h2>
                <div class="performance-stats">
                    <div class="stat-item">
                        <span class="stat-label">Sample Rate:</span>
                        <span id="sample-rate" class="stat-value">-- Hz</span>
                        <div class="rate-indicator">
                            <div id="rate-bar" class="rate-bar"></div>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Data Points:</span>
                        <span id="data-count" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Buffer Size:</span>
                        <span id="buffer-size" class="stat-value">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Recording Time:</span>
                        <span id="recording-time" class="stat-value">00:00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Memory Usage:</span>
                        <span id="memory-usage" class="stat-value">-- MB</span>
                    </div>
                </div>
            </div>
            
            <div class="controls">
                <div id="status-indicator" class="status-indicator status-idle" role="status" aria-live="polite">
                    <span>Ready to record</span>
                </div>
                
                <div class="recording-controls">
                    <button id="start-btn" class="button button-primary" aria-describedby="recording-help">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <circle cx="12" cy="12" r="10"/>
                        </svg>
                        START RECORDING
                    </button>
                    <button id="stop-btn" class="button button-error" style="display: none;" aria-describedby="recording-help">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <rect x="6" y="6" width="12" height="12"/>
                        </svg>
                        STOP RECORDING
                    </button>
                </div>
                
                <div id="recording-help" class="help-text">
                    Recording will capture GPS location, accelerometer, and gyroscope data at high frequency.
                </div>
                
                <div id="post-recording-controls" class="post-recording-controls">
                    <button id="download-btn" class="button button-secondary" aria-describedby="download-help">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                        </svg>
                        DOWNLOAD CSV
                    </button>
                    <button id="upload-btn" class="button button-secondary" aria-describedby="upload-help">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                            <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                        </svg>
                        UPLOAD JSON
                    </button>
                </div>
                
                <div id="download-help" class="help-text">
                    Download recorded data as CSV file for analysis in spreadsheet applications.
                </div>
                <div id="upload-help" class="help-text">
                    Upload recorded data to server for processing and storage.
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title">Live Sensor Data</h2>
            <div class="data-display">
                <div class="data-group" role="group" aria-labelledby="gps-heading">
                    <div id="gps-heading" class="data-group-title">GPS</div>
                    <div class="data-item">
                        <span class="data-label">Latitude:</span>
                        <span id="gps-lat" class="data-value" aria-live="polite">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Longitude:</span>
                        <span id="gps-lon" class="data-value" aria-live="polite">--</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Accuracy:</span>
                        <span id="gps-error" class="data-value" aria-live="polite">-- m</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Altitude:</span>
                        <span id="gps-alt" class="data-value" aria-live="polite">-- m</span>
                    </div>
                </div>
                
                <div class="data-group" role="group" aria-labelledby="accel-heading">
                    <div id="accel-heading" class="data-group-title">Accelerometer</div>
                    <div class="data-item">
                        <span class="data-label">X:</span>
                        <span id="accel-x" class="data-value" aria-live="polite">-- m/s¬≤</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Y:</span>
                        <span id="accel-y" class="data-value" aria-live="polite">-- m/s¬≤</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Z:</span>
                        <span id="accel-z" class="data-value" aria-live="polite">-- m/s¬≤</span>
                    </div>
                </div>
                
                <div class="data-group" role="group" aria-labelledby="gyro-heading">
                    <div id="gyro-heading" class="data-group-title">Gyroscope</div>
                    <div class="data-item">
                        <span class="data-label">Alpha:</span>
                        <span id="gyro-alpha" class="data-value" aria-live="polite">-- ¬∞/s</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Beta:</span>
                        <span id="gyro-beta" class="data-value" aria-live="polite">-- ¬∞/s</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Gamma:</span>
                        <span id="gyro-gamma" class="data-value" aria-live="polite">-- ¬∞/s</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="card-title">Application Info</h2>
            <div class="app-info">
                <div class="info-item">
                    <span class="info-label">User ID:</span>
                    <span id="user-id" class="info-value">Loading...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Version:</span>
                    <span class="info-value">2.0.0</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status:</span>
                    <span id="app-status" class="info-value">Initializing...</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Online Status:</span>
                    <span id="online-status" class="info-value online">Online</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Storage:</span>
                    <span id="storage-usage" class="info-value">Calculating...</span>
                </div>
            </div>
            
            <!-- Data Management Controls -->
            <div class="data-management-controls" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--md-sys-color-outline-variant);">
                <button id="clear-data-btn" class="button button-secondary" style="width: 100%; margin-bottom: 8px;" aria-describedby="clear-data-help">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                    CLEAR ALL DATA
                </button>
                <button id="export-data-btn" class="button button-secondary" style="width: 100%;" aria-describedby="export-data-help">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                        <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.89 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                    </svg>
                    EXPORT ALL DATA
                </button>
                
                <div id="clear-data-help" class="help-text" style="margin-top: 8px;">
                    Remove all stored recordings, data points, and reset user ID. This action cannot be undone.
                </div>
                <div id="export-data-help" class="help-text">
                    Download all stored data as a comprehensive JSON file including all recordings and metadata.
                </div>
            </div>
        </div>
        
        <div class="privacy-notice">
            <p><strong>Privacy Notice:</strong> This application collects location and motion sensor data for research purposes. Data is stored locally on your device and only uploaded when you explicitly choose to do so. No data is transmitted without your consent.</p>
        </div>
    </div>
    
    <!-- Notification container -->
    <div id="notification" class="notification" role="alert" aria-live="assertive"></div>
    
    <!-- Loading indicator -->
    <div id="loading" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text">Processing...</div>
    </div>
    
    <!-- Performance Monitor Styles -->
    <style>
        .performance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .stat-item {
            background: var(--md-sys-color-surface);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--md-sys-color-outline-variant);
        }

        .stat-label {
            display: block;
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            display: block;
            font-family: 'Roboto Mono', monospace;
            font-size: 18px;
            font-weight: 500;
            color: var(--md-sys-color-primary);
        }

        .rate-indicator {
            margin-top: 8px;
            height: 4px;
            background: var(--md-sys-color-surface-variant);
            border-radius: 2px;
            overflow: hidden;
        }

        .rate-bar {
            height: 100%;
            background: linear-gradient(90deg, 
                var(--md-sys-color-error) 0%, 
                var(--md-sys-color-warning) 50%, 
                var(--md-sys-color-success) 100%);
            width: 0%;
            transition: width 200ms ease;
        }

        /* Color coding for sample rates */
        .stat-value.rate-low { color: var(--md-sys-color-error); }
        .stat-value.rate-medium { color: var(--md-sys-color-warning); }
        .stat-value.rate-high { color: var(--md-sys-color-success); }
        
        /* Online status styling */
        .info-value.online {
            color: var(--md-sys-color-success);
        }
        
        .info-value.offline {
            color: var(--md-sys-color-error);
        }
    </style>

    <!-- Performance Monitor Script -->
    <script>
        // Performance monitoring code
        class PerformanceMonitor {
            constructor() {
                this.startTime = null;
                this.dataCount = 0;
                this.intervalId = null;
                this.sampleTimes = [];
                this.maxSamples = 100;
            }
            
            start() {
                this.startTime = Date.now();
                this.dataCount = 0;
                this.sampleTimes = [];
                
                this.intervalId = setInterval(() => {
                    this.updateRecordingTime();
                    this.updateMemoryUsage();
                }, 1000);
            }
            
            stop() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
            }
            
            addSample() {
                const now = Date.now();
                this.sampleTimes.push(now);
                this.dataCount++;
                
                if (this.sampleTimes.length > this.maxSamples) {
                    this.sampleTimes.shift();
                }
                
                if (this.sampleTimes.length > 1) {
                    const duration = (now - this.sampleTimes[0]) / 1000;
                    const rate = this.sampleTimes.length / duration;
                    this.updateSampleRate(rate);
                }
                
                const dataCountEl = document.getElementById('data-count');
                if (dataCountEl) {
                    dataCountEl.textContent = this.dataCount.toLocaleString();
                }
            }
            
            updateSampleRate(rate) {
                const element = document.getElementById('sample-rate');
                const barElement = document.getElementById('rate-bar');
                
                if (element) {
                    element.textContent = `${rate.toFixed(1)} Hz`;
                    
                    if (rate < 50) {
                        element.className = 'stat-value rate-low';
                    } else if (rate < 100) {
                        element.className = 'stat-value rate-medium';
                    } else {
                        element.className = 'stat-value rate-high';
                    }
                }
                
                if (barElement) {
                    const percentage = Math.min((rate / 140) * 100, 100);
                    barElement.style.width = `${percentage}%`;
                }
            }
            
            updateRecordingTime() {
                if (!this.startTime) return;
                
                const elapsed = Math.floor((Date.now() - this.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                const timeEl = document.getElementById('recording-time');
                if (timeEl) {
                    timeEl.textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
            
            updateMemoryUsage() {
                if (performance.memory) {
                    const mb = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
                    const memoryEl = document.getElementById('memory-usage');
                    if (memoryEl) {
                        memoryEl.textContent = `${mb} MB`;
                    }
                }
            }
            
            updateBufferSize(size) {
                const bufferEl = document.getElementById('buffer-size');
                if (bufferEl) {
                    bufferEl.textContent = size.toLocaleString();
                }
            }
        }

        window.performanceMonitor = new PerformanceMonitor();
    </script>
    
    <!-- Configuration and Scripts -->
    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nanoid/4.0.0/nanoid.min.js"></script>
    
    <!-- Main Application Module -->
    <script type="module" src="app.js"></script>
    
    <!-- Feature detection and fallbacks -->
    <script>
        // Check for required features
        const requiredFeatures = {
            serviceWorker: 'serviceWorker' in navigator,
            indexedDB: 'indexedDB' in window,
            geolocation: 'geolocation' in navigator,
            deviceMotion: 'DeviceMotionEvent' in window,
            webWorkers: typeof Worker !== 'undefined',
            modules: 'noModule' in HTMLScriptElement.prototype
        };
        
        // Display feature support info for debugging
        if (window.location.search.includes('debug=true')) {
            console.log('Feature support:', requiredFeatures);
        }
        
        // Warn about missing critical features
        const missingFeatures = Object.entries(requiredFeatures)
            .filter(([, supported]) => !supported)
            .map(([feature]) => feature);
            
        if (missingFeatures.length > 0) {
            console.warn('Missing features:', missingFeatures);
            
            if (missingFeatures.includes('modules')) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h1>Browser Not Supported</h1>
                        <p>This application requires a modern browser with ES6 module support.</p>
                        <p>Please update your browser or try a different one.</p>
                        <p>Missing features: ${missingFeatures.join(', ')}</p>
                    </div>
                `;
            }
        }
        
        // Update online status
        function updateOnlineStatus() {
            const statusEl = document.getElementById('online-status');
            if (statusEl) {
                const isOnline = navigator.onLine;
                statusEl.textContent = isOnline ? 'Online' : 'Offline';
                statusEl.className = `info-value ${isOnline ? 'online' : 'offline'}`;
            }
        }
        
        // Monitor online/offline status
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initial status check
        document.addEventListener('DOMContentLoaded', updateOnlineStatus);
    </script>

<!-- Add this script before closing </body> tag to fix the issues -->
<script>
// Quick fixes for storage info and button functionality
document.addEventListener('DOMContentLoaded', () => {
    // Wait for app to initialize
    setTimeout(async () => {
        console.log('üîß Applying quick fixes...');
        
        // Fix 1: Manual storage calculation
        async function updateStorageInfo() {
            try {
                const storageEl = document.getElementById('storage-usage');
                if (!storageEl) return;
                
                // Try modern storage API
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usageMB = ((estimate.usage || 0) / 1048576).toFixed(1);
                    const quotaMB = ((estimate.quota || 0) / 1048576).toFixed(0);
                    const percent = estimate.quota ? ((estimate.usage || 0) / estimate.quota * 100).toFixed(1) : '0';
                    
                    storageEl.textContent = `${usageMB} MB / ${quotaMB} MB (${percent}%)`;
                    console.log('‚úÖ Storage info updated');
                } else {
                    storageEl.textContent = 'Storage API not available';
                }
            } catch (error) {
                console.warn('Storage calculation failed:', error);
                const storageEl = document.getElementById('storage-usage');
                if (storageEl) storageEl.textContent = 'Error calculating';
            }
        }
        
        // Fix 2: Manual clear data functionality
        function setupClearDataButton() {
            const clearBtn = document.getElementById('clear-data-btn');
            if (!clearBtn) return;
            
            clearBtn.addEventListener('click', async () => {
                const confirmed = confirm('‚ö†Ô∏è WARNING: This will permanently delete ALL stored data including recordings, data points, and your user ID. This cannot be undone.\n\nAre you sure you want to continue?');
                
                if (confirmed) {
                    try {
                        // Show loading
                        clearBtn.textContent = 'Clearing...';
                        clearBtn.disabled = true;
                        
                        // Clear IndexedDB
                        if (window.app && window.app.databaseManager) {
                            await window.app.databaseManager.clearAllData();
                        }
                        
                        // Clear other storage
                        if ('localStorage' in window) localStorage.clear();
                        if ('sessionStorage' in window) sessionStorage.clear();
                        
                        // Clear cookies (regenerate user ID)
                        if (window.app && window.app.userManager) {
                            window.app.userManager.clearUserId();
                            await window.app.userManager.init();
                        }
                        
                        // Update UI
                        await updateStorageInfo();
                        
                        clearBtn.textContent = 'CLEAR ALL DATA';
                        clearBtn.disabled = false;
                        
                        alert('‚úÖ All data cleared successfully! A new User ID has been generated.');
                        console.log('‚úÖ Clear data completed');
                        
                    } catch (error) {
                        console.error('Clear data failed:', error);
                        alert('‚ùå Failed to clear data: ' + error.message);
                        clearBtn.textContent = 'CLEAR ALL DATA';
                        clearBtn.disabled = false;
                    }
                }
            });
            
            console.log('‚úÖ Clear data button setup');
        }
        
        // Fix 3: Manual export data functionality
        function setupExportDataButton() {
            const exportBtn = document.getElementById('export-data-btn');
            if (!exportBtn) return;
            
            exportBtn.addEventListener('click', async () => {
                try {
                    exportBtn.textContent = 'Exporting...';
                    exportBtn.disabled = true;
                    
                    if (!window.app || !window.app.databaseManager) {
                        throw new Error('App not initialized');
                    }
                    
                    // Get all recordings
                    const recordings = await window.app.databaseManager.getRecordings();
                    
                    if (recordings.length === 0) {
                        alert('No data to export. Record some data first.');
                        exportBtn.textContent = 'EXPORT ALL DATA';
                        exportBtn.disabled = false;
                        return;
                    }
                    
                    const exportData = {
                        metadata: {
                            exportDate: new Date().toISOString(),
                            userId: window.app.userManager.getUserId(),
                            version: '2.0.0',
                            totalRecordings: recordings.length
                        },
                        recordings: []
                    };
                    
                    // Get data points for each recording
                    for (const recording of recordings) {
                        const dataPoints = await window.app.databaseManager.getDataPoints(recording.id);
                        exportData.recordings.push({
                            ...recording,
                            dataPoints: dataPoints
                        });
                    }
                    
                    // Create and download file
                    const jsonContent = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([jsonContent], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `motion-recorder-export-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    
                    exportBtn.textContent = 'EXPORT ALL DATA';
                    exportBtn.disabled = false;
                    
                    const totalDataPoints = exportData.recordings.reduce((sum, r) => sum + r.dataPoints.length, 0);
                    alert(`‚úÖ Exported ${recordings.length} recordings with ${totalDataPoints} data points`);
                    console.log('‚úÖ Export completed');
                    
                } catch (error) {
                    console.error('Export failed:', error);
                    alert('‚ùå Export failed: ' + error.message);
                    exportBtn.textContent = 'EXPORT ALL DATA';
                    exportBtn.disabled = false;
                }
            });
            
            console.log('‚úÖ Export data button setup');
        }
        
        // Fix 4: Create some test data for testing export
        async function createTestDataIfNeeded() {
            try {
                if (!window.app || !window.app.databaseManager) return;
                
                const recordings = await window.app.databaseManager.getRecordings();
                
                if (recordings.length === 0) {
                    console.log('Creating test data for export testing...');
                    
                    const userId = window.app.userManager.getUserId();
                    const testRecording = {
                        userId: userId,
                        timestamp: new Date().toISOString(),
                        status: 'completed',
                        sampleRate: 140,
                        batteryLevel: 1.0,
                        endTime: new Date().toISOString(),
                        dataPointCount: 3,
                        averageHz: 140
                    };
                    
                    const recordingId = await window.app.databaseManager.saveRecording(testRecording);
                    
                    const testDataPoints = [
                        {
                            recordingTimestamp: testRecording.timestamp,
                            userId: userId,
                            gpsTimestamp: new Date().toISOString(),
                            gpsLat: 37.7749,
                            gpsLon: -122.4194,
                            gpsError: 5.0,
                            timestamp: Date.now()
                        },
                        {
                            recordingTimestamp: testRecording.timestamp,
                            userId: userId,
                            accelTimestamp: new Date().toISOString(),
                            accelX: 0.1,
                            accelY: 0.2,
                            accelZ: 9.8,
                            timestamp: Date.now()
                        },
                        {
                            recordingTimestamp: testRecording.timestamp,
                            userId: userId,
                            gyroTimestamp: new Date().toISOString(),
                            gyroAlpha: 1.5,
                            gyroBeta: -0.8,
                            gyroGamma: 0.3,
                            timestamp: Date.now()
                        }
                    ];
                    
                    await window.app.databaseManager.saveDataPoints(testDataPoints, recordingId);
                    console.log('‚úÖ Test data created');
                    
                    // Update storage after creating data
                    await updateStorageInfo();
                }
            } catch (error) {
                console.warn('Could not create test data:', error);
            }
        }
        
        // Apply all fixes
        await updateStorageInfo();
        setupClearDataButton();
        setupExportDataButton();
        await createTestDataIfNeeded();
        
        // Update storage info every 30 seconds
        setInterval(updateStorageInfo, 30000);
        
        console.log('‚úÖ All quick fixes applied');
        
    }, 3000); // Wait 3 seconds for app initialization
});
</script>
    
</body>
</html>
